<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub App Authentication Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .result {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2d3748;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ GitHub API Dashboard</h1>
            <p>Complete GitHub data access with REST API v3 + GraphQL v4 + GitHub Discussions</p>
        </div>

        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="showTab('install')">Installation</div>
                <div class="tab" onclick="showTab('collection')">üìä Data Collection</div>
                <div class="tab" onclick="showTab('smart')">Smart Auth</div>
                <div class="tab" onclick="showTab('graphql')">GraphQL Analytics</div>
                <div class="tab" onclick="showTab('discussions')">Discussions</div>
                <div class="tab" onclick="showTab('basic')">Basic Auth</div>
                <div class="tab" onclick="showTab('custom')">Custom Tests</div>
            </div>

            <!-- Installation Tab -->
            <div id="install" class="tab-content active">
                <div class="section">
                    <h2>üîß GitHub App Installation</h2>
                    <p>Install your GitHub App to access repositories and test authentication</p>
                    
                    <div class="button-group">
                        <button class="btn" onclick="checkInstallationStatus()">Check Status</button>
                        <button class="btn btn-success" onclick="installGitHubApp()">Install GitHub App</button>
                        <button class="btn btn-secondary" onclick="showInstallationGuide()">Installation Guide</button>
                    </div>
                    
                    <div id="installationStatus" style="display: none;"></div>
                </div>
            </div>

            <!-- Data Collection Tab -->
            <div id="collection" class="tab-content">
                <div class="section">
                    <h2>üìä Repository Data Collection</h2>
                    <p>Collect and store all GitHub data for invisible labor tracking</p>
                    
                    <div class="input-group">
                        <label>üîç Search Repositories:</label>
                        <input type="text" id="repoSearchInput" placeholder="Search by repository name, description, or language..." 
                               style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 14px;"
                               onkeyup="filterRepositories()">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="loadRepositoriesForCollection()">üîÑ Load My Repositories</button>
                        <button class="btn btn-secondary" onclick="listCollectedRepositories()">üìÅ View Collected Data</button>
                        <button class="btn btn-warning" onclick="clearSearch()">üóëÔ∏è Clear Search</button>
                    </div>
                    
                    <div id="repositoryList" style="display: none; margin-top: 20px;">
                        <h3>Select a Repository to Collect Data</h3>
                        <div id="searchInfo" style="margin-bottom: 10px; padding: 10px; background: #f7fafc; border-radius: 6px; display: none;">
                            <span id="searchResultsCount" style="color: #667eea; font-weight: 600;"></span>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 10px;">
                            <div id="repoListContainer"></div>
                        </div>
                    </div>
                </div>

                <div id="collectionForm" class="section" style="display: none;">
                    <h2>Collect Data for: <span id="selectedRepoName" style="color: #667eea;"></span></h2>
                    
                    <div class="input-group">
                        <label>Number of Days to Collect:</label>
                        <select id="collectionDays" style="padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; width: 100%; font-size: 14px;">
                            <option value="7">Last 7 days</option>
                            <option value="14">Last 14 days</option>
                            <option value="30" selected>Last 30 days (Recommended)</option>
                            <option value="60">Last 60 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-success" onclick="startDataCollection()" id="collectBtn">
                            üöÄ Start Data Collection
                        </button>
                        <button class="btn" onclick="cancelCollection()">
                            ‚ùå Cancel
                        </button>
                    </div>

                    <div id="collectionProgress" style="display: none;">
                        <div style="background: #e1e5e9; height: 10px; border-radius: 5px; overflow: hidden; margin: 20px 0;">
                            <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; color: #667eea; font-weight: 600; margin-bottom: 20px;"></div>
                    </div>

                    <div id="collectionLog" class="result" style="display: none;"></div>

                    <div id="collectionStats" style="display: none; margin-top: 20px;">
                        <h3>üìà Collection Results</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statMaintainers">0</div>
                                <div>üë• Maintainers</div>
                            </div>
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statIssues">0</div>
                                <div>üêõ Issues</div>
                            </div>
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statPRs">0</div>
                                <div>üîÄ Pull Requests</div>
                            </div>
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statReviews">0</div>
                                <div>üëÅÔ∏è Reviews</div>
                            </div>
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statComments">0</div>
                                <div>üí¨ Comments</div>
                            </div>
                            <div class="status success" style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold;" id="statCommits">0</div>
                                <div>üìù Commits</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="collectedDataView" class="section" style="display: none;">
                    <h2>üìÅ Collected Repositories</h2>
                    <div id="collectedReposList"></div>
                </div>
            </div>

            <!-- Smart GitHub Auth Tab -->
            <div id="smart" class="tab-content">
                <div class="section">
                    <h2>üß† Smart GitHub Auth (Recommended)</h2>
                    <p>Like Vercel/Lovable - automatically discovers installations and handles authentication</p>
                    
                    <div class="button-group">
                        <button class="btn" onclick="testEndpoint('/api/v1/github-smart-auth/app/info')">App Info</button>
                        <button class="btn" onclick="testEndpoint('/api/v1/github-smart-auth/app/installations')">Get Installations</button>
                        <button class="btn btn-secondary" onclick="testEndpoint('/api/v1/github-smart-auth/repositories')">Get Repositories</button>
                    </div>

                    <div class="input-group">
                        <label>Test Specific Repository:</label>
                        <input type="text" id="repoInput" placeholder="owner/repo (e.g., octocat/Hello-World)" value="octocat/Hello-World">
                        <button class="btn btn-success" onclick="testSpecificRepo()">Test Repository</button>
                    </div>
                </div>
            </div>

            <!-- GraphQL Analytics Tab -->
            <div id="graphql" class="tab-content">
                <div class="section">
                    <h2>üöÄ GraphQL v4 Analytics</h2>
                    <p>Advanced GitHub data using GraphQL API - contributions, analytics, and detailed metrics</p>
                    
                    <div class="input-group">
                        <label>GitHub Username:</label>
                        <input type="text" id="graphqlUsername" placeholder="username (e.g., octocat)" value="octocat">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="getUserContributions()">üìä User Contributions</button>
                        <button class="btn btn-secondary" onclick="getUserRepositoriesDetailed()">üìö Detailed Repos</button>
                        <button class="btn btn-success" onclick="getOrganizationMembers()">üë• Org Members</button>
                        <button class="btn btn-warning" onclick="searchRepositories()">üîç Search Repos</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìà Repository Analytics</h2>
                    <p>Get comprehensive repository analytics and metrics</p>
                    
                    <div class="input-group">
                        <label>Repository (owner/repo):</label>
                        <input type="text" id="analyticsRepo" placeholder="owner/repo (e.g., octocat/Hello-World)" value="octocat/Hello-World">
                    </div>
                    
                    <div class="input-group">
                        <label>Since Date (ISO format):</label>
                        <input type="text" id="sinceDate" placeholder="2024-01-01T00:00:00Z" value="2024-01-01T00:00:00Z">
                    </div>
                    
                    <button class="btn" onclick="getRepositoryAnalytics()">üìä Get Repository Analytics</button>
                </div>
            </div>

            <!-- GitHub Discussions Tab -->
            <div id="discussions" class="tab-content">
                <div class="section">
                    <h2>üí¨ GitHub Discussions</h2>
                    <p>Access GitHub Discussions data (GraphQL only) - categories, discussions, and comments</p>
                    
                    <div class="input-group">
                        <label>Repository (owner/repo):</label>
                        <input type="text" id="discussionsRepo" placeholder="owner/repo (e.g., microsoft/vscode)" value="microsoft/vscode">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn" onclick="getDiscussionCategories()">üè∑Ô∏è Discussion Categories</button>
                        <button class="btn btn-secondary" onclick="getRepositoryDiscussions()">üí¨ Get Discussions</button>
                        <button class="btn btn-success" onclick="searchDiscussions()">üîç Search Discussions</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üéØ Specific Discussion</h2>
                    <p>Get detailed information about a specific discussion</p>
                    
                    <div class="input-group">
                        <label>Discussion Number:</label>
                        <input type="number" id="discussionNumber" placeholder="123" value="1">
                    </div>
                    
                    <button class="btn" onclick="getSpecificDiscussion()">üìù Get Discussion Details</button>
                </div>
            </div>

            <!-- Basic GitHub Auth Tab -->
            <div id="basic" class="tab-content">
                <div class="section">
                    <h2>üîß Basic GitHub Auth</h2>
                    <p>Traditional GitHub App authentication with installation ID</p>
                    
                    <div class="button-group">
                        <button class="btn" onclick="testEndpoint('/api/v1/github/auth/test')">Test Auth</button>
                        <button class="btn" onclick="testEndpoint('/api/v1/github/auth/installations')">Get Installations</button>
                        <button class="btn btn-secondary" onclick="testEndpoint('/api/v1/github/repositories')">Get Repositories</button>
                    </div>
                </div>
            </div>

            <!-- Custom Tests Tab -->
            <div id="custom" class="tab-content">
                <div class="section">
                    <h2>üéØ Custom Tests</h2>
                    <p>Test specific endpoints with custom parameters</p>
                    
                    <div class="input-group">
                        <label>Custom Endpoint:</label>
                        <input type="text" id="customEndpoint" placeholder="/api/v1/github-smart-auth/repositories/octocat/Hello-World/contents">
                    </div>
                    
                    <div class="input-group">
                        <label>Query Parameters (optional):</label>
                        <input type="text" id="queryParams" placeholder="path=&limit=10">
                    </div>
                    
                    <button class="btn btn-warning" onclick="testCustomEndpoint()">Test Custom Endpoint</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Testing authentication...</p>
            </div>

            <div id="result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        async function testEndpoint(endpoint) {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ SUCCESS: ${endpoint}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${endpoint}\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${endpoint}\n\n${error.message}`, 'error');
            }
            hideLoading();
        }

        async function testSpecificRepo() {
            const repo = document.getElementById('repoInput').value;
            if (!repo) {
                showResult('‚ùå Please enter a repository (owner/repo)', 'error');
                return;
            }
            
            const [owner, repoName] = repo.split('/');
            if (!owner || !repoName) {
                showResult('‚ùå Please enter repository in format: owner/repo', 'error');
                return;
            }
            
            showLoading();
            try {
                // Test repository details
                const repoResponse = await fetch(`${API_BASE}/api/v1/github-smart-auth/repositories/${owner}/${repoName}`);
                const repoData = await repoResponse.json();
                
                // Test repository contents
                const contentsResponse = await fetch(`${API_BASE}/api/v1/github-smart-auth/repositories/${owner}/${repoName}/contents`);
                const contentsData = await contentsResponse.json();
                
                let result = `‚úÖ REPOSITORY TEST: ${owner}/${repoName}\n\n`;
                result += `üìÅ Repository Details:\n${JSON.stringify(repoData, null, 2)}\n\n`;
                result += `üìÇ Repository Contents:\n${JSON.stringify(contentsData, null, 2)}`;
                
                showResult(result, 'success');
            } catch (error) {
                showResult(`‚ùå ERROR testing repository ${owner}/${repoName}\n\n${error.message}`, 'error');
            }
            hideLoading();
        }

        async function testCustomEndpoint() {
            const endpoint = document.getElementById('customEndpoint').value;
            const queryParams = document.getElementById('queryParams').value;
            
            if (!endpoint) {
                showResult('‚ùå Please enter an endpoint', 'error');
                return;
            }
            
            const fullUrl = queryParams ? `${API_BASE}${endpoint}?${queryParams}` : `${API_BASE}${endpoint}`;
            
            showLoading();
            try {
                const response = await fetch(fullUrl);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ SUCCESS: ${fullUrl}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${fullUrl}\n\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${fullUrl}\n\n${error.message}`, 'error');
            }
            hideLoading();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
            resultDiv.className = `result ${type}`;
        }

        // Installation functions
        async function checkInstallationStatus() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/install/status`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('installationStatus');
                statusDiv.style.display = 'block';
                
                if (data.installed) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ GitHub App is installed! (${data.count} installation${data.count > 1 ? 's' : ''})
                        </div>
                        <div class="result">${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            ‚ùå GitHub App is not installed yet
                        </div>
                        <div class="result">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                showResult(`‚ùå Error checking installation status: ${error.message}`, 'error');
            }
            hideLoading();
        }

        function installGitHubApp() {
            // Open installation URL in new tab - redirect to GitHub
            window.open(`${API_BASE}/api/v1/github-smart-auth/install`, '_blank');
        }

        async function showInstallationGuide() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/install/guide`);
                const data = await response.json();
                
                let guideHtml = `<h3>${data.title}</h3>`;
                
                data.steps.forEach(step => {
                    guideHtml += `
                        <div style="margin: 15px 0; padding: 15px; border-left: 4px solid #667eea; background: #f8f9fa;">
                            <h4>Step ${step.step}: ${step.title}</h4>
                            <p>${step.description}</p>
                            ${step.permissions ? `<p><strong>Permissions:</strong> ${step.permissions.join(', ')}</p>` : ''}
                            ${step.options ? `<p><strong>Options:</strong> ${step.options.join(', ')}</p>` : ''}
                            ${step.endpoints ? `<p><strong>Test Endpoints:</strong> ${step.endpoints.join(', ')}</p>` : ''}
                        </div>
                    `;
                });
                
                if (data.troubleshooting) {
                    guideHtml += `<h3>Troubleshooting</h3>`;
                    data.troubleshooting.common_issues.forEach(issue => {
                        guideHtml += `
                            <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7;">
                                <strong>${issue.issue}:</strong> ${issue.solution}
                            </div>
                        `;
                    });
                }
                
                showResult(guideHtml, 'success');
            } catch (error) {
                showResult(`‚ùå Error getting installation guide: ${error.message}`, 'error');
            }
            hideLoading();
        }

        // GraphQL Analytics Functions
        async function getUserContributions() {
            const username = document.getElementById('graphqlUsername').value;
            if (!username) {
                showResult('‚ùå Please enter a username', 'error');
                return;
            }
            
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/graphql/contributions?username=${username}&from_date=${startDate}&to_date=${endDate}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ USER CONTRIBUTIONS: ${username}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function getUserRepositoriesDetailed() {
            const username = document.getElementById('graphqlUsername').value;
            if (!username) {
                showResult('‚ùå Please enter a username', 'error');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/graphql/repositories?username=${username}&first=10`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ DETAILED REPOSITORIES: ${username}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function getOrganizationMembers() {
            const org = prompt('Enter organization name:');
            if (!org) return;
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/graphql/org-members?org=${org}&first=20`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ ORGANIZATION MEMBERS: ${org}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function searchRepositories() {
            const query = prompt('Enter search query (e.g., "language:python stars:>1000"):');
            if (!query) return;
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/graphql/search?query=${encodeURIComponent(query)}&first=10`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ REPOSITORY SEARCH: "${query}"\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function getRepositoryAnalytics() {
            const repo = document.getElementById('analyticsRepo').value;
            const since = document.getElementById('sinceDate').value;
            
            if (!repo) {
                showResult('‚ùå Please enter a repository (owner/repo)', 'error');
                return;
            }
            
            const [owner, repoName] = repo.split('/');
            if (!owner || !repoName) {
                showResult('‚ùå Please enter repository in format: owner/repo', 'error');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/graphql/analytics?owner=${owner}&repo=${repoName}&since=${encodeURIComponent(since)}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ REPOSITORY ANALYTICS: ${owner}/${repoName}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        // GitHub Discussions Functions
        async function getDiscussionCategories() {
            const repo = document.getElementById('discussionsRepo').value;
            if (!repo) {
                showResult('‚ùå Please enter a repository (owner/repo)', 'error');
                return;
            }
            
            const [owner, repoName] = repo.split('/');
            if (!owner || !repoName) {
                showResult('‚ùå Please enter repository in format: owner/repo', 'error');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/discussions/categories?owner=${owner}&repo=${repoName}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ DISCUSSION CATEGORIES: ${owner}/${repoName}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function getRepositoryDiscussions() {
            const repo = document.getElementById('discussionsRepo').value;
            if (!repo) {
                showResult('‚ùå Please enter a repository (owner/repo)', 'error');
                return;
            }
            
            const [owner, repoName] = repo.split('/');
            if (!owner || !repoName) {
                showResult('‚ùå Please enter repository in format: owner/repo', 'error');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/discussions?owner=${owner}&repo=${repoName}&first=10`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ REPOSITORY DISCUSSIONS: ${owner}/${repoName}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function searchDiscussions() {
            const query = prompt('Enter discussion search query (e.g., "discussions:>0 language:python"):');
            if (!query) return;
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/discussions/search?query=${encodeURIComponent(query)}&first=10`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ DISCUSSION SEARCH: "${query}"\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function getSpecificDiscussion() {
            const repo = document.getElementById('discussionsRepo').value;
            const number = document.getElementById('discussionNumber').value;
            
            if (!repo || !number) {
                showResult('‚ùå Please enter repository and discussion number', 'error');
                return;
            }
            
            const [owner, repoName] = repo.split('/');
            if (!owner || !repoName) {
                showResult('‚ùå Please enter repository in format: owner/repo', 'error');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/discussions/${owner}/${repoName}/${number}`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ DISCUSSION DETAILS: ${owner}/${repoName}#${number}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        // Test connection on page load
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/app/info`);
                if (response.ok) {
                    showResult('‚úÖ Connected to API server successfully! GitHub Smart Auth is ready.', 'success');
                } else {
                    showResult('‚ö†Ô∏è API server responded but with an error. Check if your app is running and configured.', 'error');
                }
            } catch (error) {
                showResult('‚ùå Cannot connect to API server. Make sure your FastAPI app is running on port 8000.', 'error');
            }
        };
        // ==================== DATA COLLECTION FUNCTIONS ====================
        
        let selectedRepository = null;
        let repositories = [];
        let filteredRepositories = [];

        async function loadRepositoriesForCollection() {
            showLoading();
            try {
                console.log('Loading repositories...');
                const response = await fetch(`${API_BASE}/api/v1/github-smart-auth/repositories`);
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (response.ok && data.success) {
                    repositories = data.repositories || [];
                    console.log('Repositories loaded:', repositories.length);
                    filteredRepositories = [...repositories]; // Initialize filtered list
                    displayRepositoryList(filteredRepositories);
                    document.getElementById('repositoryList').style.display = 'block';
                    updateSearchInfo();
                    showResult(`‚úÖ Loaded ${repositories.length} repositories from your accessible accounts`, 'success');
                } else {
                    console.error('API Error:', data);
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                console.error('Network Error:', error);
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        function displayRepositoryList(repos) {
            console.log('Displaying repositories:', repos.length);
            const container = document.getElementById('repoListContainer');
            console.log('Container element:', container);
            
            if (repos.length === 0) {
                const searchTerm = document.getElementById('repoSearchInput').value.trim();
                if (searchTerm) {
                    container.innerHTML = '<p style="padding: 20px; text-align: center; color: #718096;">No repositories found matching your search. Try a different search term.</p>';
                } else {
                    container.innerHTML = '<p style="padding: 20px; text-align: center; color: #718096;">No repositories found. Make sure your GitHub App is installed and you have access to repositories.</p>';
                }
                return;
            }

            container.innerHTML = repos.map(repo => {
                const [owner, name] = repo.full_name.split('/');
                return `
                    <div style="border: 2px solid #e1e5e9; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" 
                         onmouseover="this.style.borderColor='#667eea'; this.style.background='#f7fafc';"
                         onmouseout="this.style.borderColor='#e1e5e9'; this.style.background='white';"
                         onclick="selectRepositoryForCollection('${repo.full_name}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h4 style="margin: 0; color: #2d3748; font-size: 1.1rem;">${name}</h4>
                            <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">
                                ${owner}
                            </span>
                        </div>
                        <p style="margin-bottom: 10px; color: #718096; font-size: 0.9rem; line-height: 1.4;">
                            ${repo.description || 'No description available'}
                        </p>
                        <div style="display: flex; gap: 15px; color: #a0aec0; font-size: 0.85rem; flex-wrap: wrap;">
                            <span>‚≠ê ${repo.stargazers_count || 0} stars</span>
                            <span>üç¥ ${repo.forks_count || 0} forks</span>
                            <span>üìù ${repo.language || 'N/A'}</span>
                            <span>üîí ${repo.private ? 'Private' : 'Public'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectRepositoryForCollection(fullName) {
            selectedRepository = repositories.find(r => r.full_name === fullName);
            
            if (!selectedRepository) {
                showResult('‚ùå Repository not found', 'error');
                return;
            }

            document.getElementById('selectedRepoName').textContent = selectedRepository.full_name;
            document.getElementById('collectionForm').style.display = 'block';
            document.getElementById('collectionProgress').style.display = 'none';
            document.getElementById('collectionLog').style.display = 'none';
            document.getElementById('collectionStats').style.display = 'none';
            
            // Scroll to form
            document.getElementById('collectionForm').scrollIntoView({ behavior: 'smooth' });
            
            showResult(`‚úÖ Selected repository: ${selectedRepository.full_name}`, 'success');
        }

        // ==================== SEARCH FUNCTIONS ====================
        
        function filterRepositories() {
            const searchTerm = document.getElementById('repoSearchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // Show all repositories if search is empty
                filteredRepositories = [...repositories];
            } else {
                // Filter repositories based on search term
                filteredRepositories = repositories.filter(repo => {
                    const name = (repo.name || '').toLowerCase();
                    const description = (repo.description || '').toLowerCase();
                    const language = (repo.language || '').toLowerCase();
                    const fullName = (repo.full_name || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           description.includes(searchTerm) || 
                           language.includes(searchTerm) ||
                           fullName.includes(searchTerm);
                });
            }
            
            displayRepositoryList(filteredRepositories);
            updateSearchInfo();
        }
        
        function updateSearchInfo() {
            const searchInfo = document.getElementById('searchInfo');
            const searchResultsCount = document.getElementById('searchResultsCount');
            const searchTerm = document.getElementById('repoSearchInput').value.trim();
            
            if (searchTerm) {
                searchInfo.style.display = 'block';
                searchResultsCount.textContent = `Found ${filteredRepositories.length} of ${repositories.length} repositories matching "${searchTerm}"`;
            } else {
                searchInfo.style.display = 'none';
            }
        }
        
        function clearSearch() {
            document.getElementById('repoSearchInput').value = '';
            filteredRepositories = [...repositories];
            displayRepositoryList(filteredRepositories);
            updateSearchInfo();
            showResult('‚úÖ Search cleared - showing all repositories', 'success');
        }

        async function startDataCollection() {
            if (!selectedRepository) {
                showResult('‚ùå Please select a repository first', 'error');
                return;
            }

            const [owner, repo] = selectedRepository.full_name.split('/');
            const days = parseInt(document.getElementById('collectionDays').value);

            // Update UI
            document.getElementById('collectBtn').disabled = true;
            document.getElementById('collectionProgress').style.display = 'block';
            document.getElementById('collectionLog').style.display = 'block';
            document.getElementById('collectionLog').innerHTML = '';
            document.getElementById('collectionStats').style.display = 'none';

            updateProgress(0, 'Initializing...');
            logCollection(`üöÄ Starting data collection for ${selectedRepository.full_name}`);
            logCollection(`üìÖ Collecting data from last ${days} days`);

            try {
                updateProgress(20, 'Sending request to server...');
                logCollection(`üì° Connecting to backend...`);

                const response = await fetch(`${API_BASE}/api/v1/data-collection/collect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        owner: owner,
                        repo: repo,
                        days: days
                    })
                });

                updateProgress(50, 'Fetching data from GitHub...');
                logCollection(`‚è≥ Backend is fetching data from GitHub APIs...`);

                const data = await response.json();

                if (data.success) {
                    updateProgress(100, 'Complete!');
                    logCollection(`‚úÖ Data collection successful!`, 'success');
                    logCollection(`üìä Total collection time: ${data.stats.collection_time.toFixed(2)} seconds`, 'success');
                    
                    // Display statistics
                    displayCollectionStats(data.stats);
                    
                    showResult(`‚úÖ Successfully collected data for ${selectedRepository.full_name}!\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    updateProgress(0, 'Failed');
                    logCollection(`‚ùå Collection failed: ${data.message}`, 'error');
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                updateProgress(0, 'Error');
                logCollection(`‚ùå Network error: ${error.message}`, 'error');
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            } finally {
                document.getElementById('collectBtn').disabled = false;
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function logCollection(message, type = 'info') {
            const logElement = document.getElementById('collectionLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#48bb78' : type === 'error' ? '#fc8181' : '#90cdf4';
            
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = `[${timestamp}] ${message}`;
            
            logElement.appendChild(line);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function displayCollectionStats(stats) {
            document.getElementById('collectionStats').style.display = 'block';
            
            document.getElementById('statMaintainers').textContent = stats.maintainers || 0;
            document.getElementById('statIssues').textContent = stats.issues || 0;
            document.getElementById('statPRs').textContent = stats.pull_requests || 0;
            document.getElementById('statReviews').textContent = stats.pr_reviews || 0;
            document.getElementById('statComments').textContent = (stats.pr_review_comments || 0) + (stats.issue_comments || 0);
            document.getElementById('statCommits').textContent = stats.commits || 0;
            
            // Display errors if any
            if (stats.errors && stats.errors.length > 0) {
                logCollection(`‚ö†Ô∏è  ${stats.errors.length} ERRORS OCCURRED DURING COLLECTION:`, 'warning');
                stats.errors.forEach((error, idx) => {
                    logCollection(`   ${idx + 1}. ${error}`, 'error');
                });
            }
            
            // Scroll to stats
            document.getElementById('collectionStats').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function cancelCollection() {
            document.getElementById('collectionForm').style.display = 'none';
            document.getElementById('collectionProgress').style.display = 'none';
            document.getElementById('collectionLog').style.display = 'none';
            document.getElementById('collectionStats').style.display = 'none';
            selectedRepository = null;
            showResult('‚úÖ Collection cancelled', 'info');
        }

        async function listCollectedRepositories() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/data-collection/repositories`);
                const data = await response.json();
                
                if (response.ok) {
                    displayCollectedRepositories(data);
                    document.getElementById('collectedDataView').style.display = 'block';
                    showResult(`‚úÖ Found ${data.total || 0} collected repositories\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        function displayCollectedRepositories(data) {
            const container = document.getElementById('collectedReposList');
            
            if (!data.repositories || data.repositories.length === 0) {
                container.innerHTML = '<p style="padding: 20px; text-align: center; color: #718096;">No data collected yet. Select a repository and start collecting!</p>';
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #667eea; font-weight: 600; margin-bottom: 15px;">Total: ${data.total} repositories with collected data</p>
                </div>
                ${data.repositories.map(repo => `
                    <div style="border: 2px solid #e1e5e9; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: white;">
                        <h3 style="margin-bottom: 10px; color: #2d3748;">${repo.full_name}</h3>
                        <p style="margin-bottom: 10px; color: #718096;">${repo.description || 'No description'}</p>
                        <div style="display: flex; gap: 20px; margin-bottom: 15px; color: #a0aec0; font-size: 0.9rem;">
                            <span>‚≠ê ${repo.stars || 0} stars</span>
                            <span>üç¥ ${repo.forks || 0} forks</span>
                            <span>üìù ${repo.language || 'N/A'}</span>
                        </div>
                        <div style="background: #f7fafc; padding: 10px; border-radius: 6px;">
                            <p style="color: #667eea; font-weight: 600; margin-bottom: 5px;">Last fetched:</p>
                            <p style="color: #718096; font-size: 0.9rem;">${new Date(repo.last_fetched).toLocaleString()}</p>
                        </div>
                        <button class="btn btn-secondary" onclick="viewRepositoryStats('${repo.full_name}')" style="margin-top: 15px; margin-right: 10px;">
                            üìä View Statistics
                        </button>
                        <button class="btn btn-success" onclick="viewRepositoryData('${repo.full_name}')" style="margin-top: 15px;">
                            üìÅ View All Data
                        </button>
                    </div>
                `).join('')}
            `;
        }

        async function viewRepositoryStats(fullName) {
            const [owner, repo] = fullName.split('/');
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/data-collection/repositories/${owner}/${repo}/stats`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ REPOSITORY STATISTICS: ${fullName}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

        async function viewRepositoryData(fullName) {
            const [owner, repo] = fullName.split('/');
            
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/v1/data-collection/repositories/${owner}/${repo}/data`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ ALL COLLECTED DATA: ${fullName}\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(`‚ùå ERROR: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå NETWORK ERROR: ${error.message}`, 'error');
            }
            hideLoading();
        }

    </script>
</body>
</html>
